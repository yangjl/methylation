---
author: "Jinliang Yang"
title: "Use the MCMCBC package to Scan Genic features"
date: 10-08-2017
output: html_notebook
---

## Setup

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
#library(tidyverse)

devtools::install_git(
  "https://git.unl.edu/jyang21/mcmcbc",
  credentials = git2r::cred_user_pass("jyang21", getPass::getPass())
)
ls(getNamespace("mcmcbc"), all.names=TRUE)
```

## Run for Type I TE

```{r}
library("data.table")
library("GenomicRanges")

## df
df <- fread("largedata/lcache/SFS_comet_blocks_CG.csv", data.table=FALSE)
df$chr <- gsub("chr", "", df$chr)
df$cid <- paste(df$chr, df$bid, sep="_")

## gff
repeats <- fread("~/dbcenter/AGP/AGPv2/repeats/ZmB73_5a_MIPS_repeats.gff", header=FALSE, data.table=FALSE)
names(repeats) <- c("seqname", "source", "repeat", "start", "end", "score",
                        "strand", "frame", "attribute")
repeats$feature <- gsub(".*type=|;name=.*", "", repeats$attribute)
gff <- repeats

out <- get_overlap_sfs(df, gff, fea="Class I Retroelements")

## run MCMCBC
library(gsl)
library(dplyr)
library(tidyr)
library(coda)
library(utils)
library(cowplot)
# If acceptance too high, increase these values to explore wider space. If acceptance too low, decrease.
res <- MCMCBC(my_sfs=out$Freq, rates=c(1E8,1E8,1E8), sd=c(0.05,0.05,0.05), k=0:40,
              conditional=FALSE, Ne=150000, ngen=100000, verbose=TRUE)
d <- mplot(res, burnin=0.1, rates=c(1E8,1E8,1E8), doplot=TRUE)

save_plot("graphs/TE_type1_mcmc.png", d)

```


# Load Data and Library


```{r}
runmcmc_geneset <- function(JOBID, typefile="largedata/type.csv", geneset, cutoff, outid){
  ## geneset: [data.frame], cols: geneid, value
  ## cutoff: cutoff for the values
  ### outid: prefix for outid

  ###### main codes:
  a <- read.csv(typefile)
  mya <- a[JOBID, ]

  ### type
  if(mya$type == "CG"){
    df <- fread("largedata/lcache/SFS_comet_blocks_CG.csv", data.table=FALSE)
  }else if(mya$type == "CHG"){
    df <- fread("largedata/lcache/SFS_comet_blocks_CHG.csv", data.table=FALSE)
  }else if(mya$type == "CHH"){
    df <- fread("largedata/lcache/SFS_comet_blocks_CHH.csv", data.table=FALSE)
  }else{
    stop("### type error!")
  }
  df$chr <- gsub("chr", "", df$chr)
  df$cid <- paste(df$chr, df$bid, sep="_")

  ### length quantile
  qt <- quantile(df$length)
  if(mya$length == 1){
    df <- subset(df, length <= qt[2])
  }else if(mya$length == 2){
    df <- subset(df, length > qt[2] & length <= qt[3])
  }else if(mya$length == 3){
    df <- subset(df, length > qt[3] & length <= qt[4])
  }else if(mya$length == 4){
    df <- subset(df, length > qt[4])
  }else if(mya$length == 0){
    df <- df
  }


  if(mya$TE == "yes"){
    repeats <- fread("~/dbcenter/AGP/AGPv2/repeats/ZmB73_5a_MIPS_repeats.gff", header=FALSE, data.table=FALSE)
    names(repeats) <- c("seqname", "source", "repeat", "start", "end", "score",
                        "strand", "frame", "attribute")

    repeats$feature <- gsub(".*type=|;name=.*", "", repeats$attribute)
    gff <- repeats
  }else if(mya$TE == "no"){

    if(!is.null(mya$gset)){
      ######## format GFF and repeat files
      gff <- fread("~/dbcenter/AGP/AGPv2/ZmB73_5b_FGS.gff", header=TRUE, data.table=FALSE)
      names(gff) <- c("seqname", "source", "feature", "start", "end", "score",
                      "strand", "frame", "attribute")

      if(mya$gset == "above"){
        #res <- read.csv("cache/stat_exon_mean_var.csv")
        gff$geneid <- gsub(";.*|_.*", "", gff$attribute)
        gff$geneid <- gsub(".*=", "", gff$geneid)
        ####
        g1 <- subset(geneset, value > cutoff)
        gff <- subset(gff, geneid %in% g1$geneid)

      }else if(mya$gset == "below"){
        #res <- read.csv("cache/stat_exon_mean_var.csv")
        gff$geneid <- gsub(";.*|_.*", "", gff$attribute)
        gff$geneid <- gsub(".*=", "", gff$geneid)
        ####
        g2 <- subset(geneset, value <= cutoff)
        gff <- subset(gff, geneid %in% g2$geneid)
      }
    }
  }

  ##########
  out <- runmcmc_overlap(df, gff, fea=mya$fs, runid=mya$id, outdir="largedata/lcache/", outid=outid)

}

```




